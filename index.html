<!doctype html>
<html>
<head>
  <meta charset="utf-8">
  <title>QuantMage Combined Exporter (no empty columns)</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <style>
    body { font-family: system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, sans-serif; margin: 24px; }
    .box { border: 1px dashed #aaa; border-radius: 12px; padding: 16px; margin-bottom: 16px; }
    .row { display: flex; gap: 12px; align-items: center; flex-wrap: wrap; }
    button { padding: 8px 12px; border-radius: 8px; border: 1px solid #999; background: #f5f5f5; cursor: pointer; }
    button:disabled { opacity: .5; cursor: not-allowed; }
    .muted { color: #666; font-size: 12px; }
    code { background: #f2f2f2; padding: 2px 6px; border-radius: 6px; }
  </style>
</head>
<body>
  <h1>QuantMage Combined Exporter</h1>
  <p class="muted">
    Drop a saved QuantMage HTML (either $ or % view). One CSV comes out with Name, URL, $-view and %-view metrics.
    <b>Columns that are empty for all rows are automatically omitted.</b> Everything runs locally in your browser.
  </p>
  <div class="box">
    <div class="row">
      <label><b>Saved HTML:</b> <input type="file" id="htmlFile" accept=".html,.htm"></label>
      <button id="runBtn" disabled>Extract â†’ Download <code>quantmage_combined_metrics.csv</code></button>
    </div>
    <div id="log" class="muted" style="margin-top:8px;"></div>
  </div>

<script>
const RE_CONST = name => new RegExp(`const\\s+${name}\\s*=\\s*(".*?");`, 's');
function parseDoubleJSON(jsStringLiteral){ const inner = JSON.parse(jsStringLiteral); return JSON.parse(inner); }
function ymdToDate(i){ const s=String(i); return new Date(+s.slice(0,4), +s.slice(4,6)-1, +s.slice(6,8)); }
function inferDates(vals, datesList, lastValueDate){
  const n=vals.length;
  if(Array.isArray(datesList)&&datesList.length>=n){ return datesList.slice(-n).map(ymdToDate); }
  const end=(typeof lastValueDate==='number')? ymdToDate(lastValueDate) : new Date();
  const out=[]; for(let i=0;i<n;i++){ const d=new Date(end); d.setDate(d.getDate()-(n-1-i)); out.push(d);} return out;
}
function pctReturns(values){ const out=[]; for(let i=1;i<values.length;i++){ const a=values[i-1], b=values[i]; if(a>0) out.push(b/a-1);} return out; }
function stdev(arr){ if(arr.length<2) return 0; const m=arr.reduce((a,b)=>a+b,0)/arr.length; const v=arr.reduce((s,x)=>s+(x-m)*(x-m),0)/arr.length; return Math.sqrt(v); }
function maxDrawdown(values){ let peak=values[0], mdd=0; const dd=[]; for(const v of values){ peak=Math.max(peak,v); const d=v/peak-1; mdd=Math.min(mdd,d); dd.push(-d);} return {mdd, dd}; }
function ulcerIndex(dd){ if(!dd.length) return NaN; const ms=dd.reduce((s,x)=>s+x*x,0)/dd.length; return Math.sqrt(ms); }
function downloadCSV(name, rows){ const blob=new Blob([rows.join('\n')],{type:'text/csv'}); const a=document.createElement('a'); a.href=URL.createObjectURL(blob); a.download=name; a.click(); setTimeout(()=>URL.revokeObjectURL(a.href), 3000); }
function toCSVRow(arr){ return arr.map(v => /[",\n]/.test(v) ? `"${String(v).replace(/"/g,'""')}"` : String(v)).join(','); }

async function run(){
  const file = document.getElementById('htmlFile').files[0];
  if(!file){ alert('Pick a saved HTML file first'); return; }
  const html = await file.text();
  const mTS = RE_CONST('trading_spells').exec(html);
  if(!mTS){ alert('Could not find "const trading_spells" in the HTML'); return; }
  const trading_spells = parseDoubleJSON(mTS[1]);
  const mDates = RE_CONST('dates').exec(html);
  const dates_list = mDates ? parseDoubleJSON(mDates[1]) : null;

  const base = "https://quantmage.app/grimoire/";
  const header = ["Name","URL","CurrentValue","AllTimePct","FromLastTrade$","FromLastTradePct","Since","CAGR","MD","K50","K25","Sharpe","Sortino","MAR","UPI","GPR","WinRate","Volatility","CumulativeReturn"];
  const table = [header];

  for (const [sid, payload] of Object.entries(trading_spells)){
    const td = payload.trading_data || {};
    const vals = Array.isArray(td.value_history) ? td.value_history : [];
    if (vals.length < 3) continue;
    const dts = inferDates(vals, dates_list, td.last_value_date);
    const x = vals.map(Number).filter(v=>v>0); if (x.length < 3) continue;

    const rets = pctReturns(x);
    const days = Math.max((dts[dts.length-1]-dts[0])/(1000*60*60*24), 1);
    const years = days/365.25;
    const growth = x[x.length-1]/x[0];
    const cagr = years>0 ? (growth**(1/years)-1) : NaN;
    const {mdd, dd} = maxDrawdown(x);
    const ui = ulcerIndex(dd);
    const upi = (ui>0) ? (cagr/ui) : NaN;
    const vol_d = stdev(rets), vol_a = vol_d*Math.sqrt(252);
    const mean_d = rets.reduce((a,b)=>a+b,0)/rets.length;
    const sharpe = vol_d>0 ? (mean_d/vol_d)*Math.sqrt(252) : NaN;
    const downs = rets.filter(r=>r<0);
    const sortino = downs.length ? (mean_d/stdev(downs))*Math.sqrt(252) : Infinity;
    const winrate = rets.filter(r=>r>0).length/rets.length;
    const gains = rets.filter(r=>r>0).reduce((a,b)=>a+b,0);
    const losses = rets.filter(r=>r<0).reduce((a,b)=>a+b,0);
    const gpr = losses<0 ? (gains/Math.abs(losses)) : Infinity;
    const mar = mdd<0 ? (cagr/Math.abs(mdd)) : Infinity;
    const cumret = growth - 1;
    const since = new Date(dts[0]).toISOString().slice(0,10);

    const pct = x => (x==null||isNaN(x)||!isFinite(x)) ? "" : (Math.round(x*10000)/100).toString();
    const num = x => (x==null||isNaN(x)||!isFinite(x)) ? "" : (Math.round(x*100)/100).toString();

    table.push([
      (payload.name || "").trim(), base+sid,
      num(x[x.length-1]), pct(cumret), "", "", since,
      pct(cagr), (mdd==null? "": pct(Math.abs(mdd))), "", "", num(sharpe), num(sortino), num(mar), num(upi), num(gpr), pct(winrate), pct(vol_a), pct(cumret)
    ]);
  }

  // Drop columns that are empty across all rows (except Name & URL)
  const keep = table[0].map((_, j) => {
    if (j <= 1) return true;
    for (let i=1; i<table.length; i++){
      if (table[i][j] && String(table[i][j]).trim() !== "") return true;
    }
    return false;
  });
  const filtered = table.map(row => row.filter((_, j) => keep[j]));

  const csv = filtered.map(r => toCSVRow(r));
  downloadCSV("quantmage_combined_metrics.csv", csv);
  document.getElementById('log').textContent = "Done. Downloaded quantmage_combined_metrics.csv (empty columns removed).";
}

document.getElementById('htmlFile').addEventListener('change', () => {
  document.getElementById('runBtn').disabled = !document.getElementById('htmlFile').files.length;
});
document.getElementById('runBtn').addEventListener('click', run);
</script>
</body>
</html>
